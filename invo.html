<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vehicle Incident Tracker</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; width: 100%; overflow-x: hidden; font-family: 'Poppins', sans-serif; }
body { background: url('https://static.wixstatic.com/media/0a13f5_c67d95c70723474ebb15de67904d2e63~mv2.jpg') no-repeat center center fixed; background-size: cover; color: #fff; padding: 2rem 1rem; min-height: 100vh; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
body::-webkit-scrollbar { display: none; }
.container { max-width: 1200px; width: 100%; margin: 0 auto; position: relative; z-index: 1; }
.header { text-align: center; color: white; margin-bottom: 20px; padding: 10px; }
.header h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); margin-bottom: 10px; text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); font-weight: 700; }
.header p { font-size: clamp(0.9rem, 3vw, 1.1rem); opacity: 0.9; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
.global-filter { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 20px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); margin-bottom: 20px; }
.global-filter h3 { color: white; margin-bottom: 18px; font-size: clamp(1rem, 3vw, 1.3rem); font-weight: 600; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.global-filter-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.global-filter-controls input[type="date"], .global-filter-controls button { padding: 12px; border-radius: 10px; font-size: clamp(0.85rem, 2.5vw, 0.95rem); backdrop-filter: blur(10px); transition: all 0.3s ease; }
.global-filter-controls input[type="date"] { border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; flex: 1 1 auto; min-width: 150px; }
.global-filter-controls input[type="date"]:focus { outline: none; background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
.global-filter-controls button { border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; cursor: pointer; }
.global-filter-controls button:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
.stat-card { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.25); padding: 20px 15px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); text-align: center; transition: all 0.3s; }
.stat-card:hover { background: rgba(255, 255, 255, 0.18); transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.25); }
.stat-card .icon { font-size: clamp(1.8rem, 5vw, 2.5rem); margin-bottom: 10px; }
.stat-card .value { font-size: clamp(1.3rem, 4vw, 2rem); font-weight: bold; color: white; margin-bottom: 5px; word-break: break-word; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.stat-card .label { color: rgba(255, 255, 255, 0.85); font-size: clamp(0.75rem, 2vw, 0.9rem); text-transform: uppercase; letter-spacing: 1px; }
.card { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 20px; padding: 25px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); margin-bottom: 20px; }
.card h2 { color: white; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid rgba(255, 255, 255, 0.3); font-size: clamp(1.2rem, 4vw, 1.5rem); text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr)); gap: 15px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-weight: 600; margin-bottom: 8px; color: white; font-size: clamp(0.85rem, 2.5vw, 0.95rem); text-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.form-group input, .form-group textarea, .form-group select { padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: white; border-radius: 10px; font-size: clamp(0.9rem, 3vw, 1rem); transition: all 0.3s; font-family: inherit; width: 100%; }
.form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255, 255, 255, 0.5); }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.4); }
.form-group textarea { resize: vertical; min-height: 80px; }
.form-group select { cursor: pointer; }
.form-group select option { background: #2a5298; color: white; }
.btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: clamp(0.85rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; width: 100%; max-width: 300px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.btn-incident { background: rgba(253, 126, 20, 0.3); color: white; }
.btn-incident:hover { background: rgba(253, 126, 20, 0.5); transform: translateY(-2px); }
.btn-incident:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-small { padding: 10px 16px; font-size: clamp(0.75rem, 2vw, 0.85rem); margin: 5px; width: auto; max-width: none; }
.btn-delete { background: rgba(220, 53, 69, 0.3); color: white; }
.btn-delete:hover { background: rgba(220, 53, 69, 0.5); }
.export-btn { background: rgba(40, 167, 69, 0.3); color: white; margin-left: 0; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.export-btn:hover { background: rgba(40, 167, 69, 0.5); transform: translateY(-2px); }
.trips-list { display: grid; gap: 15px; }
.incident-item { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 18px; border-radius: 18px; border-left: 4px solid rgba(220, 53, 69, 0.6); transition: all 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.incident-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
.trip-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
.incident-date { font-size: clamp(0.9rem, 3vw, 1.1rem); font-weight: bold; flex: 1 1 auto; min-width: 150px; text-shadow: 0 2px 8px rgba(0,0,0,0.2); color: #fca5a5; }
.trip-actions { display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-end; }
.trip-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr)); gap: 15px; margin-bottom: 10px; }
.trip-detail { display: flex; align-items: center; gap: 10px; }
.trip-detail .icon { font-size: clamp(1rem, 3vw, 1.2rem); flex-shrink: 0; }
.trip-detail .content { flex: 1; min-width: 0; }
.trip-detail .content .label { font-size: clamp(0.7rem, 2vw, 0.8rem); color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 0.5px; }
.trip-detail .content .value { font-weight: 600; color: white; font-size: clamp(0.85rem, 2.5vw, 0.95rem); word-break: break-word; }
.trip-notes { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 12px; margin-top: 10px; color: rgba(255, 255, 255, 0.9); font-size: clamp(0.85rem, 2.5vw, 0.95rem); word-break: break-word; }
.no-trips { text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.6); }
.no-trips .icon { font-size: clamp(3rem, 10vw, 5rem); margin-bottom: 20px; opacity: 0.3; }
.no-trips h3 { font-size: clamp(1.2rem, 4vw, 1.5rem); margin-bottom: 10px; color: rgba(255, 255, 255, 0.8); }
.filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: stretch; }
.filter-bar input, .filter-bar select { padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: white; border-radius: 10px; font-size: clamp(0.85rem, 2.5vw, 0.9rem); flex: 1 1 auto; min-width: 120px; transition: all 0.3s; }
.filter-bar input::placeholder { color: rgba(255, 255, 255, 0.5); }
.filter-bar input:focus, .filter-bar select:focus { outline: none; background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.4); }
.filter-bar select option { background: #2a5298; color: white; }
.image-upload-area { border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 30px 15px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
.image-upload-area:hover { border-color: rgba(102, 126, 234, 0.6); background: rgba(102, 126, 234, 0.1); }
.image-upload-area div { color: white; }
.image-upload-area small { color: rgba(255, 255, 255, 0.7); }
.receipt-thumbnail { max-width: 120px; max-height: 120px; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin: 5px; object-fit: cover; border: 1px solid rgba(255, 255, 255, 0.2); }
.receipt-thumbnail:hover { transform: scale(1.08); box-shadow: 0 6px 25px rgba(0,0,0,0.3); }
.images-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; justify-content: center; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(10px); overflow: auto; }
.modal-content-image { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90vh; text-align: center; }
.modal-image { max-width: 100%; max-height: 85vh; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.6); }
.close-modal { position: fixed; top: 20px; right: 30px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; padding: 10px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; line-height: 1; transition: all 0.3s; }
.close-modal:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
.toast { position: fixed; bottom: 20px; right: 20px; background: rgba(40, 167, 69, 0.25); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 16px 24px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.3s, slideOut 0.3s 2.7s; font-size: clamp(0.9rem, 2.5vw, 1rem); max-width: 320px; }
.toast.warning { background: rgba(255, 193, 7, 0.25); }
.toast.error { background: rgba(220, 53, 69, 0.25); }
.loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
#pdfExportContent { display: none; }
.pdf-page { background: white; padding: 40px; max-width: 1000px; margin: 0 auto; font-family: Arial, sans-serif; color: #000 !important; }
.pdf-title { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 30px; color: #333 !important; border-bottom: 4px solid #dc3545; padding-bottom: 15px; }
.pdf-section { margin-bottom: 40px; page-break-inside: avoid; }
.pdf-section-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; color: #dc3545 !important; border-left: 5px solid #dc3545; padding-left: 15px; background: #fff0f0; padding: 12px 15px; border-radius: 5px; }
.pdf-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; page-break-inside: avoid; }
.pdf-gallery img { width: 100%; height: 180px; object-fit: cover; border: 2px solid #ccc; border-radius: 6px; }
.pdf-trip-detail { margin-bottom: 30px; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; page-break-inside: avoid; background: #fafafa; }
.pdf-trip-header { font-size: 16px; font-weight: bold; color: #dc3545 !important; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #dc3545; }
.pdf-trip-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 12px; margin-bottom: 15px; }
.pdf-trip-info-item { padding: 8px; color: #333 !important; }
.pdf-trip-info-label { font-weight: bold; color: #555 !important; display: inline-block; min-width: 90px; }
@media print {
  @page { margin: 0.75in; size: A4; }
  body { background: white !important; padding: 0 !important; }
  #pdfExportContent { display: block !important; }
  .container, .header, .card, .modal, .global-filter, .stats-grid { display: none !important; }
  .pdf-page { background: white !important; color: #000 !important; padding: 0 !important; margin: 0 auto !important; max-width: 80% !important; }
}
@media (max-width: 768px) {
  body { background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%) !important; background-attachment: fixed !important; padding: 10px; }
  .header { margin-bottom: 15px; background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 20px; }
  .global-filter, .stat-card, .card { background: rgba(255, 255, 255, 0.15); }
  .global-filter, .card { padding: 18px 12px; }
  .global-filter-controls { flex-direction: column; }
  .global-filter-controls input[type="date"], .global-filter-controls button { width: 100%; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
  .stat-card { padding: 18px 12px; }
  .form-grid, .trip-details { grid-template-columns: 1fr; gap: 12px; }
  .trip-header { flex-direction: column; align-items: stretch; }
  .trip-actions { justify-content: stretch; width: 100%; }
  .trip-actions .btn { flex: 1; }
  .filter-bar { flex-direction: column; gap: 10px; }
  .filter-bar input, .filter-bar select, .filter-bar button { width: 100%; }
  .btn { max-width: none; width: 100%; }
  .btn-small { font-size: 0.8rem; padding: 10px 12px; }
  .incident-item { padding: 15px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚ö†Ô∏è Vehicle Incident Tracker</h1>
    <p>Report and track vehicle incidents - Data saved to server</p>
  </div>

  <div class="global-filter">
    <h3>üìÖ Filter Incidents by Date Range</h3>
    <div class="global-filter-controls">
      <input type="date" id="globalStartDate">
      <input type="date" id="globalEndDate">
      <button onclick="applyGlobalFilter()">Apply Filter</button>
      <button onclick="clearGlobalFilter()" style="background: rgba(108, 117, 125, 0.3);">Clear Filter</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="icon">‚ö†Ô∏è</div>
      <div class="value" id="totalIncidents">0</div>
      <div class="label">Total Incidents</div>
    </div>
    <div class="stat-card">
      <div class="icon">üöó</div>
      <div class="value" id="totalVehicles">0</div>
      <div class="label">Vehicles Affected</div>
    </div>
    <div class="stat-card">
      <div class="icon">üë§</div>
      <div class="value" id="totalDrivers">0</div>
      <div class="label">Drivers Involved</div>
    </div>
    <div class="stat-card">
      <div class="icon">üì∑</div>
      <div class="value" id="totalPhotos">0</div>
      <div class="label">Photos Uploaded</div>
    </div>
  </div>

  <div class="card">
    <h2>‚ö†Ô∏è Report New Incident</h2>
    <form id="incidentForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="incidentDate">Date *</label>
          <input type="date" id="incidentDate" required>
        </div>
        <div class="form-group">
          <label for="incidentTime">Time</label>
          <input type="time" id="incidentTime">
        </div>
        <div class="form-group">
          <label for="incidentDriverName">Driver's Name *</label>
          <input type="text" id="incidentDriverName" placeholder="e.g., John Smith" required>
        </div>
        <div class="form-group">
          <label for="incidentVehicleReg">Vehicle Registration *</label>
          <input type="text" id="incidentVehicleReg" placeholder="e.g., ABC-123-GP" required>
        </div>
        <div class="form-group">
          <label for="incidentLocation">Location *</label>
          <input type="text" id="incidentLocation" placeholder="Where did it happen?" required>
        </div>
        <div class="form-group">
          <label for="incidentType">Incident Type *</label>
          <select id="incidentType" required>
            <option value="Scratch">Scratch</option>
            <option value="Dent">Dent</option>
            <option value="Collision">Collision</option>
            <option value="Flat Tire">Flat Tire</option>
            <option value="Broken Glass">Broken Glass</option>
            <option value="Paint Damage">Paint Damage</option>
            <option value="Mechanical Issue">Mechanical Issue</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="incidentDescription">Description *</label>
        <textarea id="incidentDescription" placeholder="Describe what happened..." required></textarea>
      </div>

      <div class="form-group">
        <label>üì∑ Photos of Damage</label>
        <div class="image-upload-area" onclick="document.getElementById('incidentImages').click()">
          <input type="file" id="incidentImages" accept="image/*" multiple style="display: none;">
          <div id="incidentUploadText">
            üì∑ Click to take photos or upload images
            <br><small>You can select multiple photos</small>
          </div>
        </div>
        <div id="incidentImagesPreview" class="images-grid"></div>
      </div>

      <button type="submit" class="btn btn-incident" id="submitBtn">
        <span id="submitBtnText">Report Incident</span>
      </button>
    </form>

    <h2 style="margin-top: 40px;">‚ö†Ô∏è Incident Reports</h2>
    <div class="filter-bar">
      <input type="text" id="incidentSearchInput" placeholder="üîç Search incidents...">
      <input type="text" id="incidentFilterDriver" placeholder="üë§ Driver Name">
      <input type="text" id="incidentFilterVehicle" placeholder="üöó Vehicle Reg">
      <select id="incidentFilterType">
        <option value="">All Types</option>
        <option value="Scratch">Scratch</option>
        <option value="Dent">Dent</option>
        <option value="Collision">Collision</option>
        <option value="Flat Tire">Flat Tire</option>
        <option value="Broken Glass">Broken Glass</option>
        <option value="Paint Damage">Paint Damage</option>
        <option value="Mechanical Issue">Mechanical Issue</option>
        <option value="Other">Other</option>
      </select>
      <button class="btn btn-small export-btn" onclick="exportToPDF()">üì• Download PDF</button>
    </div>
    <div class="trips-list" id="incidentList"></div>
  </div>
</div>

<div id="pdfExportContent"></div>

<div id="imageModal" class="modal">
  <span class="close-modal" onclick="closeImageModal()">&times;</span>
  <div class="modal-content-image">
    <img id="modalImage" class="modal-image">
  </div>
</div>

<script>
// ===== CONFIGURATION =====
// IMPORTANT: Replace this with your actual server API endpoint
const API_BASE_URL = 'iwr https://encore.dev/install.ps1 | iex'; // ‚Üê CHANGE THIS!

let incidents = [];
let currentIncidentImages = [];
let globalStartDate = null;
let globalEndDate = null;

document.getElementById('incidentDate').valueAsDate = new Date();

// ===== API FUNCTIONS =====
async function loadIncidents() {
  try {
    const response = await fetch(`${API_BASE_URL}/incidents`);
    if (response.ok) {
      incidents = await response.json();
      renderIncidents();
      updateStatistics();
    }
  } catch (error) {
    console.error('Error loading incidents:', error);
    showToast('‚ö†Ô∏è Error loading data', 'error');
  }
}

async function saveIncident(incidentData) {
  try {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading"></span> Saving...';
    
    const response = await fetch(`${API_BASE_URL}/incidents`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(incidentData)
    });
    
    if (response.ok) {
      const savedIncident = await response.json();
      incidents.unshift(savedIncident);
      renderIncidents();
      updateStatistics();
      showToast('‚úÖ Incident report saved successfully!');
      resetIncidentForm();
    } else {
      showToast('‚ö†Ô∏è Error saving incident', 'error');
    }
  } catch (error) {
    console.error('Error saving incident:', error);
    showToast('‚ö†Ô∏è Error saving incident', 'error');
  } finally {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span id="submitBtnText">Report Incident</span>';
  }
}

async function deleteIncident(id) {
  try {
    const response = await fetch(`${API_BASE_URL}/incidents/${id}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      incidents = incidents.filter(i => i.id !== id);
      renderIncidents();
      updateStatistics();
      showToast('üóëÔ∏è Incident report deleted');
    } else {
      showToast('‚ö†Ô∏è Error deleting incident', 'error');
    }
  } catch (error) {
    console.error('Error deleting incident:', error);
    showToast('‚ö†Ô∏è Error deleting incident', 'error');
  }
}

// ===== FORM HANDLING =====
document.getElementById('incidentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const incident = {
    date: document.getElementById('incidentDate').value,
    time: document.getElementById('incidentTime').value,
    driverName: document.getElementById('incidentDriverName').value,
    vehicleReg: document.getElementById('incidentVehicleReg').value.toUpperCase(),
    location: document.getElementById('incidentLocation').value,
    type: document.getElementById('incidentType').value,
    description: document.getElementById('incidentDescription').value,
    images: currentIncidentImages
  };
  
  await saveIncident(incident);
});

function resetIncidentForm() {
  document.getElementById('incidentForm').reset();
  document.getElementById('incidentDate').valueAsDate = new Date();
  currentIncidentImages = [];
  document.getElementById('incidentImagesPreview').innerHTML = '';
  document.getElementById('incidentUploadText').style.display = 'block';
}

// ===== IMAGE UPLOAD =====
document.getElementById('incidentImages').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  currentIncidentImages = [];
  const previewDiv = document.getElementById('incidentImagesPreview');
  previewDiv.innerHTML = '';
  
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(event) {
      currentIncidentImages.push(event.target.result);
      const img = document.createElement('img');
      img.src = event.target.result;
      img.className = 'receipt-thumbnail';
      img.onclick = () => viewImage(event.target.result);
      previewDiv.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
  
  if (files.length > 0) {
    document.getElementById('incidentUploadText').style.display = 'none';
  }
});

function viewImage(imageSrc) {
  document.getElementById('modalImage').src = imageSrc;
  document.getElementById('imageModal').style.display = 'block';
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

window.onclick = function(event) {
  if (event.target == document.getElementById('imageModal')) {
    closeImageModal();
  }
}

// ===== FILTERING =====
function applyGlobalFilter() {
  globalStartDate = document.getElementById('globalStartDate').value;
  globalEndDate = document.getElementById('globalEndDate').value;
  
  if (!globalStartDate && !globalEndDate) {
    showToast('‚ö†Ô∏è Please select at least one date', 'warning');
    return;
  }
  
  renderIncidents();
  updateStatistics();
  showToast('‚úÖ Filter applied successfully');
}

function clearGlobalFilter() {
  globalStartDate = null;
  globalEndDate = null;
  document.getElementById('globalStartDate').value = '';
  document.getElementById('globalEndDate').value = '';
  renderIncidents();
  updateStatistics();
  showToast('‚úÖ Filter cleared');
}

function isWithinGlobalDateRange(dateString) {
  if (!globalStartDate && !globalEndDate) return true;
  const itemDate = new Date(dateString);
  const start = globalStartDate ? new Date(globalStartDate) : null;
  const end = globalEndDate ? new Date(globalEndDate) : null;
  
  if (start && end) return itemDate >= start && itemDate <= end;
  else if (start) return itemDate >= start;
  else if (end) return itemDate <= end;
  return true;
}

// ===== RENDERING =====
function renderIncidents() {
  const incidentList = document.getElementById('incidentList');
  const searchTerm = document.getElementById('incidentSearchInput').value.toLowerCase();
  const filterType = document.getElementById('incidentFilterType').value;
  const filterDriver = document.getElementById('incidentFilterDriver').value.toLowerCase();
  const filterVehicle = document.getElementById('incidentFilterVehicle').value.toLowerCase();
  
  let filteredIncidents = incidents.filter(incident => {
    const matchesSearch = incident.driverName.toLowerCase().includes(searchTerm) || 
      incident.vehicleReg.toLowerCase().includes(searchTerm) ||
      incident.location.toLowerCase().includes(searchTerm) || 
      incident.description.toLowerCase().includes(searchTerm);
    const matchesType = !filterType || incident.type === filterType;
    const matchesDriver = !filterDriver || incident.driverName.toLowerCase().includes(filterDriver);
    const matchesVehicle = !filterVehicle || incident.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDateRange = isWithinGlobalDateRange(incident.date);
    return matchesSearch && matchesType && matchesDriver && matchesVehicle && matchesDateRange;
  });
  
  if (filteredIncidents.length === 0) {
    incidentList.innerHTML = `
      <div class="no-trips">
        <div class="icon">‚ö†Ô∏è</div>
        <h3>No incidents found</h3>
        <p>Try adjusting your filters or report your first incident!</p>
      </div>
    `;
    return;
  }
  
  incidentList.innerHTML = filteredIncidents.map(incident => `
    <div class="incident-item">
      <div class="trip-header">
        <div class="incident-date">‚ö†Ô∏è ${formatDate(incident.date)} ${incident.time ? '‚Ä¢ ' + incident.time : ''}</div>
        <div class="trip-actions">
          <button class="btn btn-small btn-delete" onclick="deleteIncident('${incident.id}')">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail">
          <div class="icon">üë§</div>
          <div class="content">
            <div class="label">Driver</div>
            <div class="value">${escapeHtml(incident.driverName)}</div>
          </div>
        </div>
        <div class="trip-detail">
          <div class="icon">üöó</div>
          <div class="content">
            <div class="label">Vehicle</div>
            <div class="value">${incident.vehicleReg}</div>
          </div>
        </div>
        <div class="trip-detail">
          <div class="icon">üìç</div>
          <div class="content">
            <div class="label">Location</div>
            <div class="value">${escapeHtml(incident.location)}</div>
          </div>
        </div>
        <div class="trip-detail">
          <div class="icon">‚ö†Ô∏è</div>
          <div class="content">
            <div class="label">Type</div>
            <div class="value">${incident.type}</div>
          </div>
        </div>
      </div>
      <div class="trip-notes">${escapeHtml(incident.description)}</div>
      ${incident.images && incident.images.length > 0 ? `
        <div style="margin-top: 15px;">
          <strong style="color: white;">üì∑ Damage Photos (${incident.images.length}):</strong>
          <div class="images-grid">
            ${incident.images.map(img => `<img src="${img}" class="receipt-thumbnail" onclick="viewImage('${img}')" alt="Incident">`).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `).join('');
}

function updateStatistics() {
  const searchTerm = document.getElementById('incidentSearchInput').value.toLowerCase();
  const filterType = document.getElementById('incidentFilterType').value;
  const filterDriver = document.getElementById('incidentFilterDriver').value.toLowerCase();
  const filterVehicle = document.getElementById('incidentFilterVehicle').value.toLowerCase();
  
  const filteredIncidents = incidents.filter(incident => {
    const matchesSearch = incident.driverName.toLowerCase().includes(searchTerm) || 
      incident.vehicleReg.toLowerCase().includes(searchTerm) ||
      incident.location.toLowerCase().includes(searchTerm) || 
      incident.description.toLowerCase().includes(searchTerm);
    const matchesType = !filterType || incident.type === filterType;
    const matchesDriver = !filterDriver || incident.driverName.toLowerCase().includes(filterDriver);
    const matchesVehicle = !filterVehicle || incident.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDateRange = isWithinGlobalDateRange(incident.date);
    return matchesSearch && matchesType && matchesDriver && matchesVehicle && matchesDateRange;
  });
  
  const uniqueVehicles = [...new Set(filteredIncidents.map(i => i.vehicleReg))].length;
  const uniqueDrivers = [...new Set(filteredIncidents.map(i => i.driverName))].length;
  const totalPhotos = filteredIncidents.reduce((sum, i) => sum + (i.images?.length || 0), 0);
  
  document.getElementById('totalIncidents').textContent = filteredIncidents.length;
  document.getElementById('totalVehicles').textContent = uniqueVehicles;
  document.getElementById('totalDrivers').textContent = uniqueDrivers;
  document.getElementById('totalPhotos').textContent = totalPhotos;
}

// ===== PDF EXPORT =====
function exportToPDF() {
  const searchTerm = document.getElementById('incidentSearchInput').value.toLowerCase();
  const filterType = document.getElementById('incidentFilterType').value;
  const filterDriver = document.getElementById('incidentFilterDriver').value.toLowerCase();
  const filterVehicle = document.getElementById('incidentFilterVehicle').value.toLowerCase();
  
  const hasFilters = globalStartDate || globalEndDate || searchTerm || filterType || filterDriver || filterVehicle;
  
  if (!hasFilters) {
    showToast('‚ö†Ô∏è Please apply at least one filter before exporting', 'warning');
    return;
  }
  
  const filteredIncidents = incidents.filter(incident => {
    const matchesSearch = incident.driverName.toLowerCase().includes(searchTerm) || 
      incident.vehicleReg.toLowerCase().includes(searchTerm) ||
      incident.location.toLowerCase().includes(searchTerm) || 
      incident.description.toLowerCase().includes(searchTerm);
    const matchesType = !filterType || incident.type === filterType;
    const matchesDriver = !filterDriver || incident.driverName.toLowerCase().includes(filterDriver);
    const matchesVehicle = !filterVehicle || incident.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDateRange = isWithinGlobalDateRange(incident.date);
    return matchesSearch && matchesType && matchesDriver && matchesVehicle && matchesDateRange;
  });
  
  if (filteredIncidents.length === 0) {
    showToast('‚ö†Ô∏è No data matches your filters!', 'warning');
    return;
  }
  
  let html = '<div class="pdf-page"><h1 class="pdf-title">‚ö†Ô∏è Vehicle Incident Reports - ' + new Date().toLocaleDateString() + '</h1>';
  html += '<div class="pdf-section"><h2 class="pdf-section-title">‚ö†Ô∏è Incidents (' + filteredIncidents.length + ')</h2>';
  
  filteredIncidents.forEach(i => {
    html += '<div class="pdf-trip-detail">';
    html += `<div class="pdf-trip-header">${formatDate(i.date)} ${i.time ? '‚Ä¢ ' + i.time : ''} - ${i.vehicleReg}</div>`;
    html += '<div class="pdf-trip-info">';
    html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Driver:</span> ${escapeHtml(i.driverName)}</div>`;
    html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Location:</span> ${escapeHtml(i.location)}</div>`;
    html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Type:</span> ${i.type}</div>`;
    html += `<div class="pdf-trip-info-item" style="grid-column: 1 / -1;"><span class="pdf-trip-info-label">Description:</span> ${escapeHtml(i.description)}</div>`;
    html += '</div>';
    
    if (i.images && i.images.length > 0) {
      html += '<div style="margin-top: 15px;"><strong style="font-size: 12px; color: #333;">üì∑ Damage Photos:</strong></div>';
      html += '<div class="pdf-gallery">';
      i.images.forEach(img => { html += `<img src="${img}" alt="Incident Photo">`; });
      html += '</div>';
    }
    html += '</div>';
  });
  
  html += '</div></div>';
  document.getElementById('pdfExportContent').innerHTML = html;
  setTimeout(() => window.print(), 100);
  showToast('üì• PDF ready: ' + filteredIncidents.length + ' records');
}

// ===== UTILITY FUNCTIONS =====
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  if (type === 'warning') toast.classList.add('warning');
  if (type === 'error') toast.classList.add('error');
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===== EVENT LISTENERS =====
document.getElementById('incidentSearchInput').addEventListener('input', () => { renderIncidents(); updateStatistics(); });
document.getElementById('incidentFilterDriver').addEventListener('input', () => { renderIncidents(); updateStatistics(); });
document.getElementById('incidentFilterVehicle').addEventListener('input', () => { renderIncidents(); updateStatistics(); });
document.getElementById('incidentFilterType').addEventListener('change', () => { renderIncidents(); updateStatistics(); });

// ===== INITIALIZE =====
window.addEventListener('load', loadIncidents);
</script>

</body>
</html>